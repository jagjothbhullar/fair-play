generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================================================
// FREE USER TRACKING (for ungated contract scanner)
// ============================================================================

model FreeUser {
  id              String   @id @default(cuid())
  email           String   @unique
  scansUsed       Int      @default(0)
  scanLimit       Int      @default(1)
  lastScanAt      DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Optional: convert to full user later
  convertedToUserId String?

  @@index([email])
}

// ============================================================================
// CORE ENTITIES
// ============================================================================

model Athlete {
  id                    String    @id @default(cuid())
  email                 String    @unique
  firstName             String
  lastName              String
  schoolId              String
  school                School    @relation(fields: [schoolId], references: [id])
  sportId               String
  sport                 Sport     @relation(fields: [sportId], references: [id])
  jerseyNumber          String?
  position              String?
  classYear             ClassYear
  eligibilityStatus     EligibilityStatus @default(ACTIVE)
  hometownCity          String?
  hometownState         String?
  hometownCountry       String    @default("USA")
  heightInches          Int?
  weightLbs             Int?
  isInternationalStudent Boolean  @default(false)
  socialHandles         Json?     // { instagram?: string, twitter?: string, tiktok?: string }
  profilePhotoUrl       String?
  bio                   String?
  openTo                String[]  // ["social_posts", "appearances", "autographs", "camps"]
  supabaseUserId        String?   @unique
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  deals            Deal[]
  complianceChecks ComplianceCheck[]

  @@index([schoolId])
  @@index([sportId])
}

model School {
  id                   String   @id @default(cuid())
  name                 String   // "Stanford University"
  shortName            String   // "Stanford"
  mascot               String   // "Cardinal"
  conferenceId         String
  conference           Conference @relation(fields: [conferenceId], references: [id])
  state                String   // "CA"
  compliancePlatform   String?  // "INFLCR", "Opendorse", "ARMS"
  complianceEmail      String?
  nilPolicyUrl         String?
  requiresPreApproval  Boolean  @default(false)
  disclosureDeadlineDays Int    @default(5)
  prohibitedCategories String[] // ["alcohol", "tobacco", ...]
  facilityUsageAllowed Boolean  @default(false)
  marksUsageAllowed    Boolean  @default(false)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  athletes         Athlete[]
  sports           SchoolSport[]
  complianceRules  ComplianceRule[]

  @@index([conferenceId])
}

model Sport {
  id             String   @id @default(cuid())
  name           String   // "Men's Basketball"
  gender         Gender
  category       String   // "basketball", "football", etc.
  isRevenueSport Boolean  @default(false)

  athletes Athlete[]
  schools  SchoolSport[]

  @@unique([name, gender])
}

model SchoolSport {
  id        String @id @default(cuid())
  schoolId  String
  school    School @relation(fields: [schoolId], references: [id])
  sportId   String
  sport     Sport  @relation(fields: [sportId], references: [id])
  rosterUrl String?

  @@unique([schoolId, sportId])
}

model Conference {
  id       String   @id @default(cuid())
  name     String   @unique // "ACC", "Mountain West", "WCC"
  division Division @default(D1)

  schools School[]
}

// ============================================================================
// DEAL MANAGEMENT
// ============================================================================

model Deal {
  id                    String     @id @default(cuid())
  athleteId             String
  athlete               Athlete    @relation(fields: [athleteId], references: [id])
  brandId               String?
  brand                 Brand?     @relation(fields: [brandId], references: [id])
  brandNameOverride     String?    // For non-registered brands
  dealType              DealType
  status                DealStatus @default(DRAFT)
  title                 String
  description           String?
  compensationCash      Decimal?   @db.Decimal(10, 2)
  compensationProducts  String?
  compensationTotalValue Decimal   @db.Decimal(10, 2)
  startDate             DateTime?
  endDate               DateTime?
  isExclusive           Boolean    @default(false)
  exclusivityCategory   String?
  exclusivityDurationMonths Int?
  contractFileUrl       String?
  contractScannedAt     DateTime?
  contractRedFlags      Json?      // Array of detected red flags
  contractSummary       String?    // AI-generated plain English summary
  complianceStatus      ComplianceStatus @default(NOT_SUBMITTED)
  disclosedToSchoolAt   DateTime?
  disclosedToNcaaAt     DateTime?
  requiresNcaaDisclosure Boolean   @default(false)
  createdAt             DateTime   @default(now())
  updatedAt             DateTime   @updatedAt

  deliverables     DealDeliverable[]
  payments         DealPayment[]
  complianceChecks ComplianceCheck[]

  @@index([athleteId])
  @@index([status])
}

model DealDeliverable {
  id          String             @id @default(cuid())
  dealId      String
  deal        Deal               @relation(fields: [dealId], references: [id], onDelete: Cascade)
  description String
  dueDate     DateTime?
  status      DeliverableStatus  @default(PENDING)
  completedAt DateTime?
  proofUrl    String?

  @@index([dealId])
}

model DealPayment {
  id           String        @id @default(cuid())
  dealId       String
  deal         Deal          @relation(fields: [dealId], references: [id], onDelete: Cascade)
  amount       Decimal       @db.Decimal(10, 2)
  paymentType  PaymentType   @default(CASH)
  expectedDate DateTime?
  receivedDate DateTime?
  status       PaymentStatus @default(PENDING)

  @@index([dealId])
}

model Brand {
  id           String   @id @default(cuid())
  name         String
  category     String?  // "food", "apparel", "automotive", etc.
  websiteUrl   String?
  logoUrl      String?
  contactEmail String?
  isVerified   Boolean  @default(false)
  createdAt    DateTime @default(now())

  deals Deal[]
}

// ============================================================================
// BRAND DISCOVERY & RECOMMENDATIONS
// ============================================================================

model OpportunityBrand {
  id                String   @id @default(cuid())
  name              String
  description       String?  @db.Text
  logoUrl           String?
  websiteUrl        String?
  applicationUrl    String?  // Where to apply/pitch
  contactEmail      String?

  // Categorization
  industry          String   // "food_beverage", "apparel", "tech", "automotive", etc.
  subcategory       String?  // "energy_drinks", "athletic_wear", "gaming", etc.

  // Location/Geographic Targeting
  reach             BrandReach  @default(NATIONAL)
  headquarters      String?     // City, State
  activeStates      String[]    // States where they do deals ["CA", "TX", "NY"]
  activeMetros      String[]    // Metro areas ["San Francisco Bay Area", "Los Angeles"]
  schoolPartnerships String[]   // Schools they have existing relationships with

  // Creator/Athlete Fit
  targetCreatorTypes CreatorType[]
  targetSports       String[]    // ["basketball", "football", "all"]
  targetNiches       String[]    // ["fitness", "gaming", "fashion", "music"]
  minFollowers       Int?        // Minimum social following
  maxFollowers       Int?        // Some brands want micro-influencers
  preferredPlatforms String[]    // ["instagram", "tiktok", "youtube", "twitch"]

  // Deal Characteristics
  typicalDealTypes   DealType[]
  budgetTier         BudgetTier  @default(MID)
  avgDealValueMin    Int?        // Typical minimum deal value
  avgDealValueMax    Int?        // Typical maximum deal value
  paysProductOnly    Boolean     @default(false)
  exclusivityRequired Boolean    @default(false)

  // Engagement & Reputation
  responseRate       ResponseRate @default(UNKNOWN)
  paymentReliability PaymentReliability @default(UNKNOWN)
  isActive           Boolean     @default(true)
  isPremiumPartner   Boolean     @default(false) // Featured/verified brands

  // Metadata
  notes              String?     @db.Text // Internal notes about the brand
  lastVerifiedAt     DateTime?
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt

  // Relations
  dealReports        BrandDealReport[]

  @@index([industry])
  @@index([reach])
  @@index([budgetTier])
}

// Community-sourced deal reports (after users complete deals)
model BrandDealReport {
  id              String   @id @default(cuid())
  brandId         String
  brand           OpportunityBrand @relation(fields: [brandId], references: [id])

  // Anonymous reporting (no direct link to user for privacy)
  creatorType     CreatorType
  sport           String?
  followerCount   Int?
  platform        String?  // Where the deal was sourced

  // Deal details
  dealType        DealType
  dealValue       Int?     // Approximate value
  wasProductOnly  Boolean  @default(false)

  // Experience ratings (1-5)
  communicationRating   Int?
  paymentSpeedRating    Int?
  overallRating         Int?
  wouldWorkAgain        Boolean?

  // Qualitative
  prosNotes       String?  @db.Text
  consNotes       String?  @db.Text
  tips            String?  @db.Text // Advice for others

  isVerified      Boolean  @default(false) // Admin verified
  createdAt       DateTime @default(now())

  @@index([brandId])
  @@index([creatorType])
}

// User-saved opportunities
model SavedOpportunity {
  id              String   @id @default(cuid())

  // Polymorphic - can be athlete or generic user
  supabaseUserId  String
  brandId         String

  status          OpportunityStatus @default(SAVED)
  notes           String?
  appliedAt       DateTime?
  followUpAt      DateTime?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([supabaseUserId, brandId])
  @@index([supabaseUserId])
}

// ============================================================================
// RECOMMENDATION ENUMS
// ============================================================================

enum BrandReach {
  LOCAL        // Single city/metro
  REGIONAL     // Multi-city or state-level
  NATIONAL     // Nationwide
  INTERNATIONAL
}

enum CreatorType {
  COLLEGE_ATHLETE
  PRO_ATHLETE
  INFLUENCER
  STREAMER
  MUSICIAN
  PODCASTER
  YOUTUBER
  OTHER_CREATOR
}

enum BudgetTier {
  MICRO        // $0-500 deals
  SMALL        // $500-2000
  MID          // $2000-10000
  LARGE        // $10000-50000
  ENTERPRISE   // $50000+
}

enum ResponseRate {
  UNKNOWN
  LOW          // <20% response rate
  MEDIUM       // 20-50%
  HIGH         // >50%
}

enum PaymentReliability {
  UNKNOWN
  POOR         // Frequent late/missing payments reported
  FAIR         // Some issues reported
  GOOD         // Generally reliable
  EXCELLENT    // Always pays on time
}

enum OpportunityStatus {
  SAVED
  APPLIED
  IN_TALKS
  DECLINED
  COMPLETED
}

// ============================================================================
// COMPLIANCE ENGINE
// ============================================================================

model ComplianceCheck {
  id        String              @id @default(cuid())
  dealId    String
  deal      Deal                @relation(fields: [dealId], references: [id], onDelete: Cascade)
  athleteId String
  athlete   Athlete             @relation(fields: [athleteId], references: [id])
  checkType ComplianceCheckType
  ruleId    String
  rule      ComplianceRule      @relation(fields: [ruleId], references: [id])
  status    ComplianceCheckStatus
  message   String?
  checkedAt DateTime            @default(now())

  @@index([dealId])
  @@index([athleteId])
}

model ComplianceRule {
  id          String           @id @default(cuid())
  scope       ComplianceScope
  schoolId    String?          // If scope is SCHOOL
  school      School?          @relation(fields: [schoolId], references: [id])
  stateCode   String?          // If scope is STATE (e.g., "CA")
  ruleCode    String           @unique // "NCAA-NIL-600", "CA-SB26-DISCLOSURE"
  title       String
  description String
  checkLogic  Json             // Machine-readable rule logic
  severity    RuleSeverity
  effectiveDate DateTime       @default(now())
  isActive    Boolean          @default(true)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  complianceChecks ComplianceCheck[]

  @@index([scope])
  @@index([schoolId])
}

model ContractTemplate {
  id              String   @id @default(cuid())
  name            String
  dealType        DealType
  description     String?
  templateContent String   @db.Text
  version         Int      @default(1)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model ContractRedFlagPattern {
  id            String       @id @default(cuid())
  name          String       // "Perpetual Rights"
  patternType   PatternType
  patternValue  String       // Regex or keywords
  severity      RuleSeverity
  explanation   String       @db.Text
  recommendation String      @db.Text
  createdAt     DateTime     @default(now())
}

// ============================================================================
// ENUMS
// ============================================================================

enum ClassYear {
  FR
  SO
  JR
  SR
  GR
  RS_FR
  RS_SO
  RS_JR
  RS_SR
}

enum EligibilityStatus {
  ACTIVE
  EXHAUSTED
  TRANSFERRED
  MEDICAL_REDSHIRT
}

enum Gender {
  M
  F
}

enum Division {
  D1
  D2
  D3
}

enum DealType {
  SOCIAL_POST
  APPEARANCE
  AUTOGRAPH
  CAMP
  LICENSING
  MERCHANDISE
  OTHER
}

enum DealStatus {
  DRAFT
  PENDING_REVIEW
  ACTIVE
  COMPLETED
  TERMINATED
  EXPIRED
}

enum ComplianceStatus {
  NOT_SUBMITTED
  PENDING
  APPROVED
  FLAGGED
  REJECTED
}

enum DeliverableStatus {
  PENDING
  COMPLETED
  OVERDUE
}

enum PaymentType {
  CASH
  PRODUCT
  SERVICE
}

enum PaymentStatus {
  PENDING
  RECEIVED
  OVERDUE
}

enum ComplianceCheckType {
  SCHOOL_POLICY
  STATE_LAW
  NCAA_RULE
  CONFERENCE_RULE
}

enum ComplianceCheckStatus {
  PASS
  FAIL
  WARNING
  NEEDS_REVIEW
}

enum ComplianceScope {
  NCAA
  STATE
  SCHOOL
  CONFERENCE
}

enum RuleSeverity {
  ERROR
  WARNING
  INFO
}

enum PatternType {
  KEYWORD
  REGEX
  SEMANTIC
}
